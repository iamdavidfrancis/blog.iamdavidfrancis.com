<?xml version="1.0" encoding="utf-8"?>


<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-us">
    <title type="text">My Blog. Sorry.</title>
    <subtitle type="html">David Francis&#39;s personal blog. Follow if you&#39;re bored I guess.</subtitle>
    <updated>2020-12-04T22:01:09+00:00</updated>
    <id>https://blog.iamdavidfrancis.com/</id>
    <link rel="alternate" type="text/html" href="https://blog.iamdavidfrancis.com/" />
    <link rel="self" type="application/atom+xml" href="https://blog.iamdavidfrancis.com/atom.xml" />
    <author>
            <name>David Francis</name>
            <uri>https://blog.iamdavidfrancis.com/</uri>
            
                <email>david@iamdavidfrancis.com</email>
            </author>
    
    <generator uri="https://gohugo.io/" version="0.79.0">Hugo</generator>
        <entry>
            <title type="text">Building a GitHub Pages site using Hugo and Azure DevOps Pipelines</title>
            <link rel="alternate" type="text/html" href="https://blog.iamdavidfrancis.com/posts/hugo-static-site-github-azure-devops/" />
            <id>https://blog.iamdavidfrancis.com/posts/hugo-static-site-github-azure-devops/</id>
            <updated>2020-12-04T13:59:49-08:00</updated>
            <published>2020-12-04T11:46:37-08:00</published>
            <author>
                    <name>David Francis</name>
                    <uri>https://iamdavidfrancis.com/</uri>
                    <email>david@iamdavidfrancis.com</email>
                    </author>
            <summary type="html"><![CDATA[Since I built this blog using GitHub pages with Hugo, I thought I&rsquo;d share the process I used to automate the build and deployments. Since GitHub pages can only serve static sites, the only two options are to publish all the HTML/CSS/JS files to a branch or use a Jekyll theme (which GitHub has native support for).]]></summary>
            
                <content type="html"><![CDATA[<p>Since I built this blog using GitHub pages with Hugo, I thought I&rsquo;d share the process I used to automate the build and deployments. Since GitHub pages can only serve static sites, the only two options are to publish all the HTML/CSS/JS files to a branch or use a Jekyll theme (which GitHub has native support for). These are both great options, and I&rsquo;ve used both in the past, but I really like how Hugo&rsquo;s site generation and content system works.</p>
<p>The downside to using Hugo? I&rsquo;d have to manually build the static content, and commit it to the <code>gh-pages</code> branch (Keeping <code>main</code> free to hold the source code that gets used by Hugo to generate the static site). I&rsquo;m not a huge fan of having to do a bunch of manual steps to publish something once I finish coding, so I figured now is the perfect time to get some practice with Continuous Integration/Continuous Deployment using Azure DevOps Pipelines.</p>
<p>I&rsquo;ve already built the site in Hugo, got the static site defined in GitHub, and I&rsquo;m using CloudFlare in front of it for the CDN and caching. The post will assume you already have a GitHub repo with a Hugo site deployed to <code>gh-pages</code> with the source code in <code>main</code>. It will cover adding automated builds for generating the Hugo site so you don&rsquo;t have to do it manually.</p>
<h2 id="cicd-plan">CI/CD Plan</h2>
<p>My goal was to have as much of the process be automated as possible. Once I push the commit to GitHub, everything else should happen automatically. The idea is to have the commit to <code>main</code> trigger an automated build in Azure Pipelines, then once the build finishes, have it trigger an automated Release that will push the build contents as a commit to the <code>gh-pages</code> branch. I also have some scripts that will invalidate the CloudFlare caches to ensure users get a fresh copy of the site when they load it after I deploy, but that&rsquo;s out of scope for this post.</p>
<h2 id="setting-up-azure-pipelines-to-build-on-new-commits">Setting up Azure Pipelines to Build on New Commits</h2>
<h3 id="connecting-to-github">Connecting to GitHub</h3>
<p>The first thing we need to do, is set up a new Pipeline to build the static site. In the Azure DevOps project, we&rsquo;ll clink on &ldquo;Pipelines&rdquo;, then the &ldquo;New Pipeline&rdquo; button. That will bring us to the &ldquo;Connect&rdquo; tab of the New Pipeline flow.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-connect.png" alt="New Pipeline Connect Tab"></p>
<p>We&rsquo;ll click on the &ldquo;GitHub&rdquo; button, which will take us to GitHub to OAuth, so that Azure DevOps can connect to the GitHub repositories.</p>
<h3 id="selecting-the-repository">Selecting the Repository</h3>
<p>Once we get back to Azure DevOps, we&rsquo;ll be on the &ldquo;Select&rdquo; tab. From this tab, we need to choose the repository we want to connect to. In my case, I&rsquo;m choosing the blog&rsquo;s repo:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-select.png" alt="New Pipeline Select Tab"></p>
<h3 id="configuring-the-pipeline">Configuring the Pipeline</h3>
<p>After we click on the repo, we will go to the &ldquo;Configure&rdquo; tab. Lets use a &ldquo;Starter pipeline&rdquo; so we can add exactly what we&rsquo;re going to need.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-configure.png" alt="New Pipeline Configure Tab"></p>
<h3 id="building-the-pipeline-yaml">Building the Pipeline YAML</h3>
<p>Now that we&rsquo;ve chosen &ldquo;Starter pipeline&rdquo; we have arrived at the &ldquo;Review&rdquo; tab. Here&rsquo;s where we will see the YAML file that will be used for the build definition. This file will actually be checked into the <code>main</code> branch of our repository and is what Azure Pipelines will use on every build. The advantage to having the build definition as code in the repo is that if we need to change how we build, we can update a file in the same place as everything else. Pushing a commit to update the build is much easier than going to the Azure DevOps site and clicking through buttons to make changes.</p>
<p>By default, the pipeline YAML file will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Starter pipeline</span><span class="w">
</span><span class="w"></span><span class="c"># Start with a minimal pipeline that you can customize to build and deploy your code.</span><span class="w">
</span><span class="w"></span><span class="c"># Add steps that build, run tests, deploy, and more:</span><span class="w">
</span><span class="w"></span><span class="c"># https://aka.ms/yaml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="l">main</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;ubuntu-latest&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">echo Hello, world!</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Run a one-line script&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    echo Add other tasks to build, test, and deploy your project.
</span><span class="sd">    echo See https://aka.ms/yaml</span><span class="w">    
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Run a multi-line script&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="adding-the-hugo-extension">Adding the Hugo Extension</h4>
<p>If you don&rsquo;t already have the hugo extension installed to your Azure DevOps, you can do that <a href="https://marketplace.visualstudio.com/items?itemName=giuliovdev.hugo-extension">here</a>. Just click the &ldquo;Get it free&rdquo; button and go through the steps to install it.</p>
<h4 id="our-build-definition">Our Build Definition</h4>
<p>We don&rsquo;t actually want most of this, so let&rsquo;s delete everything except:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="l">main</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s add the rest of the YAML contents we&rsquo;re going to need (I&rsquo;ll go over what each section is for):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l">self</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.BuildId)&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build Hugo Site</span><span class="w">
</span><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">checkout</span><span class="p">:</span><span class="w"> </span><span class="l">self</span><span class="w">
</span><span class="w">          </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout repository including submodules&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">submodules</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">HugoTask@1</span><span class="w">
</span><span class="w">          </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Generate Hugo site&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.ArtifactStagingDirectory)&#39;</span><span class="w">
</span><span class="w">            </span><span class="nt">baseURL</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://blog.iamdavidfrancis.com/&#39;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PublishPipelineArtifact@0</span><span class="w">
</span><span class="w">          </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish Hugo site as an artifact&#39;</span><span class="w">
</span><span class="w">          </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">artifactName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;hugo-site&#39;</span><span class="w">
</span><span class="w">            </span><span class="nt">targetPath</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.ArtifactStagingDirectory)&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>First we&rsquo;re setting what resources we&rsquo;re going to need in this build. The repository is going to be this repository and we&rsquo;re going to build on a windows machine. We also want to tag the built artifact with the current BuildId:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l">self</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.BuildId)&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">&#39;vs2017-win2016</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>After we&rsquo;ve set all of this, we can actually define our build pipeline. Pipelines are broken down in to individual stages, with each stage having some number of jobs, and each job having some number of steps. As you can imagine, this allows for super customized builds. Since we&rsquo;re building a simple static site, we are only going to set up one stage and one job, both called &lsquo;Build&rsquo;:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">stages</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build Hugo Site</span><span class="w">
</span><span class="w">  </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re going to add three steps to this build:</p>
<ol>
<li>Checkout the repository</li>
<li>Build the Hugo site</li>
<li>Publish the built files as an artifact.</li>
</ol>
<p>You&rsquo;ll notice that this doesn&rsquo;t actually deploy the site anywhere. We&rsquo;ll set up deployment in the next section. It&rsquo;s good to split up the build and deployment processes so that you can change one without needing to mess with the other. If at some point in the future we need to completely change the build process, the release process will continue to work as long as we&rsquo;re publishing the same artifact.</p>
<h5 id="step-1-checking-out-the-repository">Step 1: Checking out the repository</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">checkout</span><span class="p">:</span><span class="w"> </span><span class="l">self</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout repository including submodules&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">submodules</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This section is fairly straightforward. We want to pull the files from the git repo, and we want to include submodules. The reason I want to include submodules, is because of how I&rsquo;ve set up my Hugo site. I have added a theme to the <code>themes</code> folder as a submodule so I can easily update the theme when the upstream pushes new changes.</p>
<h5 id="step-2-building-the-hugo-site">Step 2: Building the Hugo site</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">HugoTask@1</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Generate Hugo site&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.ArtifactStagingDirectory)&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">baseURL</span><span class="p">:</span><span class="w"> </span><span class="l">&#39;https://blog.iamdavidfrancis.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Luckily someone has already built an extension for Azure DevOps to do the heavy lifting here. We don&rsquo;t need to run any scripts ourselves. More information on the extension can be found <a href="https://github.com/giuliov/hugo-vsts-extension/">here</a>. The extension has a few inputs that are optional, but the <code>destination</code> is required. This is the folder where the build will output the files. We&rsquo;re using <code>Build.ArtifactStagingDirectory</code> as this the default location Azure DevOps gives us for artifacts we want to publish.</p>
<p>I&rsquo;m also setting the <code>baseURL</code> property. This is useful as it allows us to use a different <code>baseURL</code> in the <code>config.toml</code>, which means we can put the production URL here and the config can have the URL used for local development. It also means that in a more complicated build setup where you have something like <code>staging</code> and <code>production</code>, you can change the <code>baseURL</code> for those as well.</p>
<h5 id="step-3-publishing-the-site-as-an-artifact">Step 3: Publishing the site as an Artifact</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PublishPipelineArtifact@0</span><span class="w">
</span><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish Hugo site as an artifact&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">artifactName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;hugo-site&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPath</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Build.ArtifactStagingDirectory)&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This step will bundle all the built files and publish them in Azure DevOps as an artifact. This artifact is what we&rsquo;ll use for our deployment pipeline later. For now we just need to give it an <code>artifactName</code> which is how we will reference it in the Release, and a <code>targetPath</code> that tells the task which directory to look in.</p>
<h3 id="running-the-new-build">Running the new Build</h3>
<p>At this point, we can hit &ldquo;Save and Run&rdquo; in the top right corner of the window:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-review.png" alt="New Pipeline Save and Run"></p>
<p>This will open a dialog asking for a commit message and which branch to commit to. This is because our build config is going to be stored as <code>azure-pipelines.yml</code> in the main branch. You can keep all the defaults and click the &ldquo;Save and run&rdquo; button on the bottom right.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-review-commit.png" alt="New Pipeline Commit Dialog"></p>
<p>This will take us to a page that looks like this:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-build.png" alt="New Pipeline Build Status"></p>
<p>If we click onto the &ldquo;Build&rdquo; job at the bottom, we will see the build steps that are being run and the logs from each step. This will tell us how long each step took, if it failed, and the output from the step. All of that can be useful for larger builds with more going on.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-pipeline-build-steps.png" alt="New Pipeline Build Steps"></p>
<p>Once the build succeeds, we know we&rsquo;re good to continue to make the Release.</p>
<h2 id="setting-up-the-release-to-deploy-to-github-pages">Setting up the Release to deploy to GitHub Pages</h2>
<p>In the Azure DevOps project, we&rsquo;ll clink on &ldquo;Releases&rdquo;, then the &ldquo;New&rdquo; button, then &ldquo;New release pipeline&rdquo; from the dropdown. That will bring us to the &ldquo;New release pipeline&rdquo; page.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-page.png" alt="New Release Pipeline Page"></p>
<p>We&rsquo;re going to click on &ldquo;Empty job&rdquo; so we can add our deployment tasks manually. The first thing we&rsquo;ll do is name the stage, I called mine &ldquo;Deploy to GitHub Pages&rdquo;:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-stage-1-name.png" alt="New Release Pipeline Page"></p>
<h3 id="configure-artifacts">Configure Artifacts</h3>
<p>Before we define the build steps, lets set up the artifacts and the build trigger. In the &ldquo;Artifacts&rdquo; box, we&rsquo;ll click the &ldquo;Add and artifact&rdquo; button. In the dialog that opens, we want to choose &ldquo;Build&rdquo; and then populate it with the build information we set up before. In the &ldquo;Source alias&rdquo; box, we&rsquo;ll enter the folder we want the artifacts put into. I&rsquo;ve called mine <code>site-build</code>. Then hit the &ldquo;Add&rdquo; button</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-artifact.png" alt="New Release Pipeline Page"></p>
<p>This will add an artifact to our Release pipeline:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-artifact-added.png" alt="New Release Pipeline Page"></p>
<p>Now we need to click the lightning bolt at the top right, and turn on the &ldquo;Continuous deployment trigger&rdquo;</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-artifact-continuous-trigger.png" alt="New Release Pipeline Page"></p>
<h3 id="configure-deployment">Configure Deployment</h3>
<h4 id="adding-the-github-pages-publish-extension">Adding the GitHub Pages Publish Extension</h4>
<p>If you don&rsquo;t already have the extension installed to your Azure DevOps, you can do that <a href="https://marketplace.visualstudio.com/items?itemName=AccidentalFish.githubpages-publish">here</a>. Just click the &ldquo;Get it free&rdquo; button and go through the steps to install it.</p>
<h4 id="github-personal-access-token">GitHub Personal Access Token</h4>
<p>At this point, we&rsquo;ll need a GitHub Personal Access Token (PAT) so that we can commit the files back to the <code>gh-pages</code> branch. Instruction on how to generate a PAT can be found <a href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token">here</a>.</p>
<p>We&rsquo;re going to add the PAT as a secure variable in the Release pipeline. To do that, we&rsquo;ll click into the &ldquo;Variables&rdquo; tab, then in the &ldquo;Pipeline variables&rdquo; section, we&rsquo;ll add a new variable called &ldquo;GitHubPAT&rdquo;. Make sure to toggle the padlock so that it stored as a secret. I set the Scope to the &ldquo;Deploy GitHub Pages&rdquo; stage to reduce the scope of access. It&rsquo;s always a good idea to restrict your variable scopes to just the stages that need them.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-github-pat.png" alt="Add the GitHub PAT to Variables"></p>
<h4 id="adding-the-deploy-to-github-pages-task">Adding the Deploy To GitHub Pages task.</h4>
<p>The next thing we need to do is to configure the deployment tasks. To get there we go to the &ldquo;Tasks&rdquo; dropdown and click on &ldquo;Deploy to GitHub Pages&rdquo;. From the screen that opens, click the &ldquo;+&rdquo; button to the right of &ldquo;Agent job&rdquo;. This will open an &ldquo;Add tasks&rdquo; window, where we will choose the &ldquo;Publish to GitHub Pages&rdquo; task. More information about this task, can be found <a href="https://github.com/JamesRandall/Vsts-GitHub-Pages-Publish">here</a>.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/new-release-stage-1-publish-task.png" alt="View stage tasks link"></p>
<p>Once we add it, we&rsquo;ll need to configure the settings for where it should publish. Here&rsquo;s the settings we&rsquo;ll want to use (You can leave &ldquo;Display Name&rdquo; and &ldquo;Commit Message&rdquo; as the defaults if you like):</p>
<table>
<thead>
<tr>
<th>Property Name</th>
<th>Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Documentation Source</td>
<td><code>$(System.DefaultWorkingDirectory)\site-build\hugo-site\*</code></td>
<td><code>$(System.DefaultWorkingDirectory)</code> is the root where all the artifacts will come in. <code>site-build</code> is the source alias we chose for our site, and &lsquo;hugo-site` was the name of the artifact we published containing the site data. |</td>
</tr>
<tr>
<td>GitHub Username</td>
<td>Your github username</td>
<td>This is the account the extension will push the commit to.</td>
</tr>
<tr>
<td>GitHub Email Address</td>
<td>You email address</td>
<td>This is used as the email on the commit that gets pushed</td>
</tr>
<tr>
<td>GitHub Personal Access Token</td>
<td><code>$(GitHubPAT)</code></td>
<td>This is the token used to authenticate against github. Since this is a secret we want to keep secure, we&rsquo;re using a variable instead of hard coding the secret here.</td>
</tr>
<tr>
<td>Repository Name</td>
<td>Your repository name</td>
<td>This is the repo that the extension will push the commit to.</td>
</tr>
<tr>
<td>Branch Name</td>
<td><code>gh-pages</code></td>
<td>This is the branch the commit will be pushed to. It should be <code>gh-pages</code> as that is one of the branches GitHub allows to be published as a static site.</td>
</tr>
</tbody>
</table>
<h3 id="saving-and-running-the-release">Saving and Running the Release</h3>
<p>Now we can hit the &ldquo;Save&rdquo; button. It will prompt for a folder, which I have left as <code>\</code>, but if you have a lot of release pipelines, it might make sense to organize them. Once we hit save, we can hit the &ldquo;Create Release&rdquo; button. Since this will be a manual release, there are some options that we are presented with for automated deployments and artifacts. We&rsquo;ll just leave everything as the default and hit Create.</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/create-release.png" alt="Create release"></p>
<p>Once the release is created and you can watch the status as it runs:</p>
<p><img src="/images/posts/hugo-static-site-github-azure-devops/create-release.png" alt="Release running"></p>
<p>After the &ldquo;Deploy to GitHub Pages&rdquo; step completes successfully, the changes should show up in the browser.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Once all of this is done, we can no check changes into our repository&rsquo;s <code>main</code> branch, and have our changes automatically appear in the static site a few minutes later. Hopefully you found this post informative and if you have any questions or see any issues, please reach out to me on <a href="https://twitter.com/iamdavidfrancis">twitter</a>.</p>
]]></content>
            
            
            
            
            
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/categories/development/" term="development" label="development" />
                            
                        
                    
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/github/" term="github" label="github" />
                            
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/azure-devops/" term="azure devops" label="azure devops" />
                            
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/ci/cd/" term="CI/CD" label="CI/CD" />
                            
                        
                    
                
            
        </entry>
    
        <entry>
            <title type="text">Using Dependency Injection in Asp.Net Core Filters &amp; Attributes</title>
            <link rel="alternate" type="text/html" href="https://blog.iamdavidfrancis.com/posts/aspnet-filter-dependency-injection/" />
            <id>https://blog.iamdavidfrancis.com/posts/aspnet-filter-dependency-injection/</id>
            <updated>2020-12-04T03:22:07-08:00</updated>
            <published>2020-12-04T01:41:00-08:00</published>
            <author>
                    <name>David Francis</name>
                    <uri>https://iamdavidfrancis.com/</uri>
                    <email>david@iamdavidfrancis.com</email>
                    </author>
            <summary type="html"><![CDATA[Sometimes when working with Asp.Net MVC or Web Apis, you&rsquo;ll want to add a Filter Attribute to a class or an endpoint. This can be an Authorization Filter, a Resource Filter, an Action Filter, etc. A common use case I have seen is adding a custom Authorization Filter.]]></summary>
            
                <content type="html"><![CDATA[<p>Sometimes when working with Asp.Net MVC or Web Apis, you&rsquo;ll want to add a Filter Attribute to a class or an endpoint. This can be an Authorization Filter, a Resource Filter, an Action Filter, etc. A common use case I have seen is adding a custom Authorization Filter. In this post, I&rsquo;ll go through some of the issues I&rsquo;ve run into while trying to add Dependency Injection to a Filter.</p>
<p>Usually a custom filter would be implemented as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeAttribute</span><span class="p">:</span> <span class="n">AuthorizeAttribute</span><span class="p">,</span> <span class="n">IAuthorizationFilter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="n">OnAuthorization</span><span class="p">(</span><span class="n">AuthorizationFilterContext</span> <span class="n">filterContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Some authorization code.
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>and then used like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="na">[HttpGet]</span>
<span class="na">[CustomAuthorize]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">IActionResult</span> <span class="n">GetItem</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Some implementation.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This allows us to move the authorization logic to a shared piece of code, to cut down on reuse and keep our controller endpoints clean. The big downside to this approach is that we can&rsquo;t use Dependency Injection. If we add a constructor with arguments to the Attribute, we&rsquo;ll have to pass a value for those arguments when we add the attribute to a class/method.</p>
<p>Let&rsquo;s say we wanted to pass in an <code>ILogger</code> so we could capture telemetry in our Authorization code. In our Controller we could inject it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">SuperAwesomeController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">SuperAwesomeController</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>But in our Attribute this won&rsquo;t work because we would need to pass in the <code>ILogger</code> when we use the attribute and attribute arguments must be a compile-time constant, which it the <code>ILogger</code> can never be.  So now we need to come up with a solution that allows us to inject services from the DI container. Asp.Net Core actually gives us two ways to do this, each with their own advantages and disadvantages: the <code>TypeFilter</code> and the <code>ServiceFilter</code>.</p>
<h2 id="typefilters">TypeFilters</h2>
<p>Type filters are a convenient way to create an attribute that instantiates the attribute per request and inject services from the container. The way we do this is by making two classes, one attribute that implements <code>TypeFilterAttribute</code> and one that is defined as the `ImplementationType' in the Type Filter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeAttribute</span> <span class="p">:</span> <span class="n">TypeFilterAttribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">CustomAuthorizeAttribute</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CustomAuthorizeFilter</span><span class="p">))</span>
    <span class="p">{</span>
        
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeFilter</span> <span class="p">:</span> <span class="n">IAuthorizationFilter</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomAuthorizeFilter</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">OnAuthorization</span><span class="p">(</span><span class="n">AuthorizationFilterContext</span> <span class="n">filterContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Some authorization code.
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now when we add the <code>[CustomAuthorize]</code> attribute to our controller, we&rsquo;re actually adding a TypeFilter that will instantiate our <code>CustomAuthorizeFilter</code> and inject the <code>ILogger</code>. One of the reasons this is so powerful is that we can extend the capabilities here a little bit. Say we wanted to pass a role into the Authorization Filter to specify more granular access to the endpoint. With a traditional attribute we would implement it as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeAttribute</span><span class="p">:</span> <span class="n">AuthorizeAttribute</span><span class="p">,</span> <span class="n">IAuthorizationFilter</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">role</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomAuthorizeAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">role</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">role</span> <span class="p">=</span> <span class="n">role</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>With the power of the <code>TypeFilter</code> we can still do that, just with a slight modification:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeAttribute</span> <span class="p">:</span> <span class="n">TypeFilterAttribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">CustomAuthorizeAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">role</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CustomAuthorizeFilter</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Arguments</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">role</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeFilter</span> <span class="p">:</span> <span class="n">IAuthorizationFilter</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">role</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomAuthorizeFilter</span><span class="p">(</span><span class="kt">string</span> <span class="n">role</span><span class="p">,</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">role</span> <span class="p">=</span> <span class="n">role</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="typefilter-benefits-and-downsides">TypeFilter Benefits and Downsides.</h3>
<p>The <code>TypeFilter</code> allows us to define our Filter in a way that gives us Dependency Injection and still allows us to pass in arguments like a normal Attribute would. The main downside here is that it has to instantiate an instance per request to our controller, adding some overhead to every request. If you don&rsquo;t need per-instance properties like this, it might be more beneficial to use a <code>ServiceFilter</code> instead.</p>
<h2 id="servicefilters">ServiceFilters</h2>
<p>Similar to a <code>TypeFilter</code>, a <code>ServiceFilter</code> allows us to add Dependency Injection to our Filters, but it goes one step further and actually pulls the Filter from our DI container, instead of making a new instance per request. This allows us to register our filter in the DI container, giving us some more control over the lifetime of it. An example implementation might look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeAttribute</span> <span class="p">:</span> <span class="n">ServiceFilterAttribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">CustomAuthorizeAttribute</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CustomAuthorizeFilter</span><span class="p">))</span>
    <span class="p">{</span>
        
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthorizeFilter</span> <span class="p">:</span> <span class="n">IAuthorizationFilter</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomAuthorizeFilter</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">OnAuthorization</span><span class="p">(</span><span class="n">AuthorizationFilterContext</span> <span class="n">filterContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Some authorization code.
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Notice how the only difference is the base type of <code>CustomAuthorizeFilter</code>. If we only did this though, we would get an exception as <code>CustomAuthorizeFilter</code> has not yet been registered in the DI container. This can easily be done by adding it to the <code>IServiceCollection</code> in <code>Startup</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cs" data-lang="cs"><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">CustomAuthorizeFilter</span><span class="p">&gt;();</span>
</code></pre></td></tr></table>
</div>
</div><p>This would register it as a Singleton, meaning only one instance will ever be created. You can register it with whatever scope fits your needs. Now you might be thinking, &ldquo;Hey David, that&rsquo;s just a normal service being added to the DI container and then using the <code>ServiceFilterAttribute</code> to wire the attribute up.&rdquo; You would be 100% correct, that is exactly what we&rsquo;re doing here. Technically you could inject any Service like this, but it really only makes sense to inject something that implements <code>IFilterMetadata</code> so that the framework can do its magic and run the code.</p>
<h3 id="servicefilter-benefits-and-downsides">ServiceFilter Benefits and Downsides.</h3>
<p>The <code>ServiceFilter</code> gives us the added advantage of using a Filter registered in the DI container, saving us the overhead of creating an instance per-request. The main downside is losing the ability to pass in arguments from the Attribute like <code>TypeFilter</code> gives us.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Both <code>TypeFilter</code> and <code>ServiceFilter</code> give us powerful tools for creating custom Attributes and Filters, along with the flexibility to choose the option that best suits our needs. Hopefully you found this post helpful and if you see any errors or issues, please reach out to me on <a href="https://twitter.com/iamdavidfrancis">twitter</a>.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-5.0">https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-5.0</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.typefilterattribute?view=aspnetcore-5.0">https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.typefilterattribute?view=aspnetcore-5.0</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.servicefilterattribute?view=aspnetcore-5.0">https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.servicefilterattribute?view=aspnetcore-5.0</a></li>
</ul>
]]></content>
            
            
            
            
            
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/categories/development/" term="development" label="development" />
                            
                        
                    
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/dotnet/" term="dotnet" label="dotnet" />
                            
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/asp.net/" term="asp.net" label="asp.net" />
                            
                        
                    
                
            
        </entry>
    
        <entry>
            <title type="text">Creating a Discord Bot with Docker</title>
            <link rel="alternate" type="text/html" href="https://blog.iamdavidfrancis.com/posts/discord-bot/" />
            <id>https://blog.iamdavidfrancis.com/posts/discord-bot/</id>
            <updated>2020-04-13T17:42:27-07:00</updated>
            <published>2020-04-11T19:11:39-07:00</published>
            <author>
                    <name>David Francis</name>
                    <uri>https://iamdavidfrancis.com/</uri>
                    <email>david@iamdavidfrancis.com</email>
                    </author>
            <summary type="html"><![CDATA[Ever want to make a Discord Bot and have no idea where to get started? Yeah me too. So I spent most of a night looking into making one and setting it up in a Docker container. Some people thought it was an interesting idea, so here&rsquo;s a write up.]]></summary>
            
                <content type="html"><![CDATA[<p>Ever want to make a Discord Bot and have no idea where to get started? Yeah me too. So I spent most of a night looking into making one and setting it up in a Docker container. Some people thought it was an interesting idea, so here&rsquo;s a write up. This post might get a little long, so I may split it up into a couple of posts.</p>
<blockquote>
<p>Update 2020-04-13: I realized that the Docker base image was over 500MB, which feels like too much for a bot this simple, so I switched the Docker base image to an alpine based version of node.</p>
</blockquote>
<h2 id="the-basic-idea-aka-what-is-this-and-why-do-i-care">The Basic Idea (A.K.A. What is this and why do I care?)</h2>
<p>Discord bots are neat. They do all kinds of things and I&rsquo;ve always wondered how they were implemented. So today we&rsquo;re going to build one together. Well, I&rsquo;m going to build one and explain how along they way. Well, I actually already built it, but I&rsquo;m building it again to explain it. Well, if you&rsquo;re reading this that means I already finished building it twice, so I guess now it&rsquo;s just you building it. At least you have my commentary to help! Unless my commentary is not useful, in which case, IDK there are other blogs explaining this, so go look at one of those.</p>
<p>Sorry, that was a long winded way of saying nothing. Anyway, here&rsquo;s the plan. We&rsquo;re going to make a bot that will listen on Discord and if someone says &ldquo;Ping&rdquo; it will reply with &ldquo;Pong&rdquo;. We&rsquo;re going to go through the entire process of setting up the bot in Discord, writing the code, turning it into a docker image, pushing the image to Azure Container Registry and then running the docker image on a machine somewhere.</p>
<p><img src="/images/gifs/hold-on-to-your-butts.gif" alt="Hold on to your butts"></p>
<h2 id="getting-started">Getting Started</h2>
<p>Before we get started, make sure you have a development environment set up. I&rsquo;m using <a href="https://code.visualstudio.com/">VS Code</a> as my IDE, but any text editor will work. You&rsquo;ll also need <a href="https://nodejs.org/">nodejs</a> (I&rsquo;m using v12.16.2 right now) and a Discord account. Get one at <a href="https://discordapp.com/">discordapp.com</a>. I&rsquo;ll also be doing this in Typescript since I like actually having a type system, but this can all be done in TS or JS. You will also need <a href="https://www.docker.com/">Docker</a> if you want to run it in a container like I do in steps 3 &amp; 4 below.</p>
<p>The steps to creating the bot are as follows:</p>
<ol>
<li><a href="#1-create-the-bot-on-discord">Create a bot on Discord</a></li>
<li><a href="#2-implement-the-bot-code-in-js">Implement the bot code in JS (or TS in our case).</a></li>
<li><a href="#3-create-the-docker-image">Create the docker image.</a></li>
<li><a href="#4-deploy-the-docker-container-and-test-the-bot">Deploy the docker container and test the bot.</a></li>
</ol>
<h2 id="1-create-the-bot-on-discord">1. Create the bot on Discord.</h2>
<p>First things first, we need to create a bot in Discord and install it into one of our servers. To create the bot you need to go to the <a href="https://discordapp.com/developers/applications">Discord Developer Portal</a>. To create the bot, we first have to create an &ldquo;application&rdquo; in their system. It&rsquo;s a few steps, but it&rsquo;s not too complicated. You&rsquo;ll need to hit the &ldquo;New Application&rdquo; button and choose a name for the Application. Just choose whatever name you want for this, I chose &ldquo;Sample Application&rdquo; and hit &ldquo;Create&rdquo;.</p>
<p>You will see a page that looks like this:
<img src="/images/posts/discord-bot/general-information.png" alt="Application general information page"></p>
<p>From this page, copy down the &ldquo;Client ID&rdquo; as we&rsquo;ll need that in a minute. Then you can click on the &ldquo;Bot&rdquo; link on the left to get to the bot config. You&rsquo;ll need to hit &ldquo;Add Bot&rdquo; and confirm it first. This will create the bot for the application.</p>
<p><img src="/images/posts/discord-bot/add-bot.png" alt="Create bot flow"></p>
<p>Once the bot has been created, you&rsquo;ll need to get the token from the bot. You can do this by clicking on the &ldquo;Click to Reveal Token&rdquo; link and copying it, or clicking the &ldquo;Copy&rdquo; button. This token is going to be important later, so put it down somewhere safe. <strong>Important: This token should never be shared with anyone as it will give whoever has it full access to the API as the bot user.</strong></p>
<p><img src="/images/posts/discord-bot/bot-details.png" alt="Create bot flow"></p>
<p>Once you have the token saved somewhere, we need to add the bot to a server so we can actually test it in the future. We&rsquo;re going to add the bot with Administrator permissions for now, but you can scope the permissions by using the tool at the bottom of the bot page to get the permission number (Administrator is 8). Once you have the number, you&rsquo;ll need to construct a url to add the bot. The URL should look like this:</p>
<p><a href="https://discordapp.com/oauth2/authorize?&amp;client_id=CLIENTID&amp;scope=bot&amp;permissions=PERMISSION">https://discordapp.com/oauth2/authorize?&amp;client_id=CLIENTID&amp;scope=bot&amp;permissions=PERMISSION</a></p>
<p>For us the PERMISSION is 8, so the URL will look something like this:</p>
<p><a href="https://discordapp.com/oauth2/authorize?&amp;client_id=0000000000&amp;scope=bot&amp;permissions=8">https://discordapp.com/oauth2/authorize?&amp;client_id=0000000000&amp;scope=bot&amp;permissions=8</a></p>
<p>Copy the URL with your Client ID and paste it into a web browser. From there you can install the bot in a server you are an admin of. You&rsquo;ll know if it worked by logging into Discord and checking if the bot user is a member of the server.</p>
<h2 id="2-implement-the-bot-code-in-js">2. Implement the bot code in JS</h2>
<p>Now that you have the bot all set up and installed in a server, we can start working on implementing it. Let&rsquo;s create a folder for working on the bot. I called mine <code>discord-bot</code>.</p>
<h3 id="21-set-up-packagejson-and-tsconfigjson">2.1 Set up package.json and tsconfig.json</h3>
<p>I&rsquo;m going to launch VS Code in that folder and finish setting up from there. VS Code has a built in terminal that you can open with <code>Ctrl+` </code>. Let&rsquo;s setup npm with <code>npm init</code>. Just enter information in the prompts or leave the defaults. Either is fine for now. This should create a <code>package.json</code> file in the file explorer. You can see that the <code>package.json</code> contains all the information from the prompts.</p>
<p><img src="/images/posts/discord-bot/npm-init.png" alt="npm init"></p>
<p>Now we need to install some packages. Run <code>npm install discord.js --save</code> to add the Discord JS library to the project. Let&rsquo;s also add <code>typescript</code> as a dev dependency with <code>npm install typescript --save-dev</code>. You&rsquo;re going to want the Nodejs typings so run <code>npm install @types/node @types/ws --save-dev</code> as well. Your <code>package.json</code> should now look something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;discord-bot&#34;</span><span class="p">,</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;test&#34;</span><span class="p">:</span> <span class="s2">&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;ISC&#34;</span><span class="p">,</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;discord.js&#34;</span><span class="p">:</span> <span class="s2">&#34;^12.1.1&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;@types/node&#34;</span><span class="p">:</span> <span class="s2">&#34;^13.11.1&#34;</span><span class="p">,</span>
    <span class="nt">&#34;@types/ws&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.2.3&#34;</span><span class="p">,</span>
    <span class="nt">&#34;typescript&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.8.3&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Next up we need to add a <code>tsconfig.json</code> file to tell typescript how to build everything. Run the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">npx tsc --init --rootDir src --outDir dist --target es6 --esModuleInterop --resolveJsonModule --module commonjs --allowJs <span class="nb">true</span> --noImplicitAny <span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><p>This will setup our <code>tsconfig.json</code> with some useful defaults. It will look like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="s2">&#34;compilerOptions&#34;</span><span class="o">:</span> <span class="p">{</span>
    <span class="cm">/* Basic Options */</span>
    <span class="c1">// &#34;incremental&#34;: true,                   /* Enable incremental compilation */
</span><span class="c1"></span>    <span class="s2">&#34;target&#34;</span><span class="o">:</span> <span class="s2">&#34;es6&#34;</span><span class="p">,</span>                          <span class="cm">/* Specify ECMAScript target version: &#39;ES3&#39; (default), &#39;ES5&#39;, &#39;ES2015&#39;, &#39;ES2016&#39;, &#39;ES2017&#39;, &#39;ES2018&#39;, &#39;ES2019&#39;, &#39;ES2020&#39;, or &#39;ESNEXT&#39;. */</span>
    <span class="s2">&#34;module&#34;</span><span class="o">:</span> <span class="s2">&#34;commonjs&#34;</span><span class="p">,</span>                     <span class="cm">/* Specify module code generation: &#39;none&#39;, &#39;commonjs&#39;, &#39;amd&#39;, &#39;system&#39;, &#39;umd&#39;, &#39;es2015&#39;, &#39;es2020&#39;, or &#39;ESNext&#39;. */</span>
    <span class="c1">// &#34;lib&#34;: [],                             /* Specify library files to be included in the compilation. */
</span><span class="c1"></span>    <span class="s2">&#34;allowJs&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>                          <span class="cm">/* Allow javascript files to be compiled. */</span>
    <span class="c1">// &#34;checkJs&#34;: true,                       /* Report errors in .js files. */
</span><span class="c1"></span>    <span class="c1">// &#34;jsx&#34;: &#34;preserve&#34;,                     /* Specify JSX code generation: &#39;preserve&#39;, &#39;react-native&#39;, or &#39;react&#39;. */
</span><span class="c1"></span>    <span class="c1">// &#34;declaration&#34;: true,                   /* Generates corresponding &#39;.d.ts&#39; file. */
</span><span class="c1"></span>    <span class="c1">// &#34;declarationMap&#34;: true,                /* Generates a sourcemap for each corresponding &#39;.d.ts&#39; file. */
</span><span class="c1"></span>    <span class="c1">// &#34;sourceMap&#34;: true,                     /* Generates corresponding &#39;.map&#39; file. */
</span><span class="c1"></span>    <span class="c1">// &#34;outFile&#34;: &#34;./&#34;,                       /* Concatenate and emit output to single file. */
</span><span class="c1"></span>    <span class="s2">&#34;outDir&#34;</span><span class="o">:</span> <span class="s2">&#34;dist&#34;</span><span class="p">,</span>                         <span class="cm">/* Redirect output structure to the directory. */</span>
    <span class="s2">&#34;rootDir&#34;</span><span class="o">:</span> <span class="s2">&#34;src&#34;</span><span class="p">,</span>                         <span class="cm">/* Specify the root directory of input files. Use to control the output directory structure with --outDir. */</span>
    <span class="c1">// &#34;composite&#34;: true,                     /* Enable project compilation */
</span><span class="c1"></span>    <span class="c1">// &#34;tsBuildInfoFile&#34;: &#34;./&#34;,               /* Specify file to store incremental compilation information */
</span><span class="c1"></span>    <span class="c1">// &#34;removeComments&#34;: true,                /* Do not emit comments to output. */
</span><span class="c1"></span>    <span class="c1">// &#34;noEmit&#34;: true,                        /* Do not emit outputs. */
</span><span class="c1"></span>    <span class="c1">// &#34;importHelpers&#34;: true,                 /* Import emit helpers from &#39;tslib&#39;. */
</span><span class="c1"></span>    <span class="c1">// &#34;downlevelIteration&#34;: true,            /* Provide full support for iterables in &#39;for-of&#39;, spread, and destructuring when targeting &#39;ES5&#39; or &#39;ES3&#39;. */
</span><span class="c1"></span>    <span class="c1">// &#34;isolatedModules&#34;: true,               /* Transpile each file as a separate module (similar to &#39;ts.transpileModule&#39;). */
</span><span class="c1"></span>
    <span class="cm">/* Strict Type-Checking Options */</span>
    <span class="s2">&#34;strict&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>                           <span class="cm">/* Enable all strict type-checking options. */</span>
    <span class="s2">&#34;noImplicitAny&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>                    <span class="cm">/* Raise error on expressions and declarations with an implied &#39;any&#39; type. */</span>
    <span class="c1">// &#34;strictNullChecks&#34;: true,              /* Enable strict null checks. */
</span><span class="c1"></span>    <span class="c1">// &#34;strictFunctionTypes&#34;: true,           /* Enable strict checking of function types. */
</span><span class="c1"></span>    <span class="c1">// &#34;strictBindCallApply&#34;: true,           /* Enable strict &#39;bind&#39;, &#39;call&#39;, and &#39;apply&#39; methods on functions. */
</span><span class="c1"></span>    <span class="c1">// &#34;strictPropertyInitialization&#34;: true,  /* Enable strict checking of property initialization in classes. */
</span><span class="c1"></span>    <span class="c1">// &#34;noImplicitThis&#34;: true,                /* Raise error on &#39;this&#39; expressions with an implied &#39;any&#39; type. */
</span><span class="c1"></span>    <span class="c1">// &#34;alwaysStrict&#34;: true,                  /* Parse in strict mode and emit &#34;use strict&#34; for each source file. */
</span><span class="c1"></span>
    <span class="cm">/* Additional Checks */</span>
    <span class="c1">// &#34;noUnusedLocals&#34;: true,                /* Report errors on unused locals. */
</span><span class="c1"></span>    <span class="c1">// &#34;noUnusedParameters&#34;: true,            /* Report errors on unused parameters. */
</span><span class="c1"></span>    <span class="c1">// &#34;noImplicitReturns&#34;: true,             /* Report error when not all code paths in function return a value. */
</span><span class="c1"></span>    <span class="c1">// &#34;noFallthroughCasesInSwitch&#34;: true,    /* Report errors for fallthrough cases in switch statement. */
</span><span class="c1"></span>
    <span class="cm">/* Module Resolution Options */</span>
    <span class="c1">// &#34;moduleResolution&#34;: &#34;node&#34;,            /* Specify module resolution strategy: &#39;node&#39; (Node.js) or &#39;classic&#39; (TypeScript pre-1.6). */
</span><span class="c1"></span>    <span class="c1">// &#34;baseUrl&#34;: &#34;./&#34;,                       /* Base directory to resolve non-absolute module names. */
</span><span class="c1"></span>    <span class="c1">// &#34;paths&#34;: {},                           /* A series of entries which re-map imports to lookup locations relative to the &#39;baseUrl&#39;. */
</span><span class="c1"></span>    <span class="c1">// &#34;rootDirs&#34;: [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */
</span><span class="c1"></span>    <span class="c1">// &#34;typeRoots&#34;: [],                       /* List of folders to include type definitions from. */
</span><span class="c1"></span>    <span class="c1">// &#34;types&#34;: [],                           /* Type declaration files to be included in compilation. */
</span><span class="c1"></span>    <span class="c1">// &#34;allowSyntheticDefaultImports&#34;: true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */
</span><span class="c1"></span>    <span class="s2">&#34;esModuleInterop&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>                  <span class="cm">/* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies &#39;allowSyntheticDefaultImports&#39;. */</span>
    <span class="c1">// &#34;preserveSymlinks&#34;: true,              /* Do not resolve the real path of symlinks. */
</span><span class="c1"></span>    <span class="c1">// &#34;allowUmdGlobalAccess&#34;: true,          /* Allow accessing UMD globals from modules. */
</span><span class="c1"></span>
    <span class="cm">/* Source Map Options */</span>
    <span class="c1">// &#34;sourceRoot&#34;: &#34;&#34;,                      /* Specify the location where debugger should locate TypeScript files instead of source locations. */
</span><span class="c1"></span>    <span class="c1">// &#34;mapRoot&#34;: &#34;&#34;,                         /* Specify the location where debugger should locate map files instead of generated locations. */
</span><span class="c1"></span>    <span class="c1">// &#34;inlineSourceMap&#34;: true,               /* Emit a single file with source maps instead of having a separate file. */
</span><span class="c1"></span>    <span class="c1">// &#34;inlineSources&#34;: true,                 /* Emit the source alongside the sourcemaps within a single file; requires &#39;--inlineSourceMap&#39; or &#39;--sourceMap&#39; to be set. */
</span><span class="c1"></span>
    <span class="cm">/* Experimental Options */</span>
    <span class="c1">// &#34;experimentalDecorators&#34;: true,        /* Enables experimental support for ES7 decorators. */
</span><span class="c1"></span>    <span class="c1">// &#34;emitDecoratorMetadata&#34;: true,         /* Enables experimental support for emitting type metadata for decorators. */
</span><span class="c1"></span>
    <span class="cm">/* Advanced Options */</span>
    <span class="s2">&#34;resolveJsonModule&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>                <span class="cm">/* Include modules imported with &#39;.json&#39; extension */</span>
    <span class="s2">&#34;forceConsistentCasingInFileNames&#34;</span><span class="o">:</span> <span class="kc">true</span>  <span class="cm">/* Disallow inconsistently-cased references to the same file. */</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that this is done, we can make a few changes to <code>package.json</code> to enable some easier testing and running. Let&rsquo;s update the <code>&quot;main&quot;</code> property to <code>dist/index.js</code> since we won&rsquo;t be running anything from <code>/src</code>. Let&rsquo;s also add some scripts to enable building and running our bot code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;scripts&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&#34;build&#34;</span><span class="p">:</span> <span class="s2">&#34;tsc&#34;</span><span class="p">,</span>
    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;node dist/index.js&#34;</span><span class="p">,</span>
    <span class="nt">&#34;debug&#34;</span><span class="p">:</span> <span class="s2">&#34;node --inspect dist/index.js&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Your <code>package.json</code> should look like this now:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;discord-bot&#34;</span><span class="p">,</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;dist/index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;build&#34;</span><span class="p">:</span> <span class="s2">&#34;tsc&#34;</span><span class="p">,</span>
    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;node dist/index.js&#34;</span><span class="p">,</span>
    <span class="nt">&#34;debug&#34;</span><span class="p">:</span> <span class="s2">&#34;node --inspect dist/index.js&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;ISC&#34;</span><span class="p">,</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;discord.js&#34;</span><span class="p">:</span> <span class="s2">&#34;^12.1.1&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;@types/node&#34;</span><span class="p">:</span> <span class="s2">&#34;^13.11.1&#34;</span><span class="p">,</span>
    <span class="nt">&#34;typescript&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.8.3&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="22-adding-the-bot-entry-point-and-connecting-to-discord">2.2 Adding the bot entry point and connecting to Discord</h3>
<p>Now that all we&rsquo;ve got typescript and node set up, let&rsquo;s get started on implementation. Let&rsquo;s create a <code>src</code> folder and put an <code>index.ts</code> file in it. The main part of this file will be creating the Discord client and connecting to Discord with it. Note: Discord.js has a ton of built in functionality and is too much to cover in this blog post. You can read the full docs <a href="https://discord.js.org/#/docs/main/stable/general/welcome">here</a>. I&rsquo;ll cover the code in the file by blocks, so the first thing we want to do is add this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">import</span> <span class="nx">Discord</span> <span class="kr">from</span> <span class="s2">&#34;discord.js&#34;</span><span class="p">;</span>

<span class="c1">// Discord token is required.
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DISCORD_TOKEN</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;DISCORD_TOKEN environment variable missing.&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">onReady</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// TODO: Implement this
</span><span class="c1"></span><span class="p">};</span>
<span class="kr">const</span> <span class="nx">onMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">message</span>: <span class="kt">Discord.Message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="c1">// TODO: Implement this
</span><span class="c1"></span><span class="p">};</span>

<span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Discord</span><span class="p">.</span><span class="nx">Client</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">);</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">onMessage</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">discordToken</span>: <span class="kt">string</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DISCORD_TOKEN</span><span class="p">;</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">discordToken</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>This will bring in the Discord library under the name <code>Discord</code>. It also will read in the token from an Environment variable. I don&rsquo;t like hard coding secrets, especially if I&rsquo;m checking them into source control. So let&rsquo;s throw if the token is not in the environment and set it to a local variable while we do the rest.</p>
<p>The <code>onReady</code> and <code>onMessage</code> handlers will be invoked once the client starts up and when incoming messages come in. We&rsquo;ll actually implement them a little later.</p>
<p>The <code>client</code> is actually the magic that will connect to Discord and calls into our <code>onReady</code> and <code>onMessage</code> callbacks.</p>
<p>The call to <code>client.login(discordToken)</code> will initiate the connection to Discord. At this point, we can add some logging into the <code>onReady</code> handler and see what happens when we run it. Update the code with the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">onReady</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Connected&#34;</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Logged in as </span><span class="si">${</span><span class="nx">client</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once that&rsquo;s in, run <code>npm run build</code> to generate the <code>dist</code> folder with the generated javascript. Once that completes, run <code>npm run start</code> to start the bot running locally. You should see something along the lines of this:</p>
<pre><code>PS D:\temp-blog\discord-bot&gt; npm run start

&gt; discord-bot@1.0.0 start D:\temp-blog\discord-bot
&gt; node dist/index.js

D:\temp-blog\discord-bot\dist\index.js:9
    throw new Error(&quot;DISCORD_TOKEN environment variable missing.&quot;);
    ^

Error: DISCORD_TOKEN environment variable missing.
</code></pre><p>This is because we haven&rsquo;t set the environment variable with our token yet. I&rsquo;m using Powershell, so I&rsquo;m going to run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$env:DISCORD_TOKEN</span> <span class="p">=</span> <span class="s1">&#39;MyToken&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>If you run <code>npm run start</code> again you should now see the log lines when you bot connects:</p>
<pre><code>PS D:\temp-blog\discord-bot&gt; npm run start

&gt; discord-bot@1.0.0 start D:\temp-blog\discord-bot
&gt; node dist/index.js

Connected
Logged in as Sample Application#2809.
</code></pre><p>Go ahead and hit <code>Ctrl+C</code> to stop the process.</p>
<h3 id="23-handling-incoming-messages">2.3 Handling incoming messages.</h3>
<p>Now that we are connected to Discord, we can implement our message handling. As I said earlier, this bot will just respond &ldquo;Pong&rdquo; when someone sends &ldquo;Ping&rdquo;, so let&rsquo;s build a pretty simple handler.</p>
<p>In our <code>onMessage</code> method let&rsquo;s add our new code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">onMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">message</span>: <span class="kt">Discord.Message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="c1">// Don&#39;t respond to bots.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">author</span><span class="p">.</span><span class="nx">bot</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;ping&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s2">&#34;Pong!&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now you can run <code>npm run build</code> and <code>npm run start</code> again. Once you see the &ldquo;Connected&rdquo; log show up, go back to your Discord server and send a message &ldquo;Ping&rdquo;. You should see this response:</p>
<p><img src="/images/posts/discord-bot/bot-output.png" alt="Bot working"></p>
<p>Now we&rsquo;re ready to start working on the Docker Image.</p>
<h2 id="3-create-the-docker-image">3. Create the Docker Image</h2>
<p>The first step to creating the Docker image will be to add a Dockerfile. Lets create a <code>Dockerfile</code> at the root of our <code>discord-bot</code> folder. Set the content of the Dockerfile to this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> node:lts-alpine3.9</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">USER</span><span class="s"> root</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> APP /usr/src/APP<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> package.json /tmp/package.json<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> npm install --loglevel<span class="o">=</span>warn <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p <span class="nv">$APP</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /tmp/node_modules <span class="nv">$APP</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> src <span class="nv">$APP</span>/src<span class="err">
</span><span class="err"></span><span class="k">COPY</span> package.json <span class="nv">$APP</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> tsconfig.json <span class="nv">$APP</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> $APP</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> npm run build<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span> <span class="s2">&#34;dist/index.js&#34;</span> <span class="p">]</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s break down what we&rsquo;re doing in there. We start with setting the base image to <code>node:lts-alpine3.9</code> to get the current LTS nodejs in our container. We&rsquo;re using an alpine linux based image, which is much smaller while still giving us everything we need.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">USER</span><span class="s"> root</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> APP /usr/src/APP<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Here we&rsquo;re setting the user to run as and adding an environment variable with the path we&rsquo;re installing the bot to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">COPY</span> package.json /tmp/package.json<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> npm install --loglevel<span class="o">=</span>warn <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p <span class="nv">$APP</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /tmp/node_modules <span class="nv">$APP</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>This is copying the <code>package.json</code> into a temp folder to run an <code>npm install</code> to download our dependencies. Then it copies the dependencies into our <code>$APP</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">COPY</span> src <span class="nv">$APP</span>/src<span class="err">
</span><span class="err"></span><span class="k">COPY</span> package.json <span class="nv">$APP</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> tsconfig.json <span class="nv">$APP</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> $APP</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>This is copying app files into the final directory and moving our working directory there.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">RUN</span> npm run build<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span> <span class="s2">&#34;dist/index.js&#34;</span> <span class="p">]</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>This builds the bot and then runs it. Now let&rsquo;s actually build our docker image. Go ahead and run this command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ps1" data-lang="ps1"><span class="n">docker</span> <span class="n">build</span> <span class="p">.</span> <span class="n">-t</span> <span class="n">discord-bot</span>
</code></pre></td></tr></table>
</div>
</div><p>This will build the image and tag it with <code>discord-bot</code>. You can you another tag if you like. Now you can try running your docker image. Remember to pass in your token via the <code>-e</code> flag. Here&rsquo;s what my command looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ps1" data-lang="ps1"><span class="n">docker</span> <span class="n">run</span> <span class="n">-e</span> <span class="n">DISCORD_TOKEN</span><span class="p">=</span><span class="nv">$env:DISCORD_TOKEN</span> <span class="n">docker-bot</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="4-deploy-the-docker-container-and-test-the-bot">4. Deploy the docker container and test the bot.</h2>
<p>To deploy the container off of your local machine, you first need to push it to your registry. I&rsquo;m going to use Azure Container Registry (ACR) since I already have one. You could always publish to DockerHub, but it was easier for me to use my existing registry. If you&rsquo;re interested in using Azure, instructions for setting up a new registry in Azure can be found <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-portal">here</a>.</p>
<p>Since I&rsquo;m using ACR for this, I need to tag my image a little differently, so I&rsquo;m going to run these commands to push it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ps1" data-lang="ps1"><span class="n">docker</span> <span class="n">tag</span> <span class="n">discord-bot</span> <span class="n">mysupercoolregistry</span><span class="p">.</span><span class="n">azurecr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">discord-bot</span>
<span class="n">docker</span> <span class="n">push</span> <span class="n">mysupercoolregistry</span><span class="p">.</span><span class="n">azurecr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">discord-bot</span><span class="err">:</span><span class="n">latest</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that it&rsquo;s deployed, I can go to my Docker VM host and run the following command to run the image:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ps1" data-lang="ps1"><span class="n">docker</span> <span class="n">run</span> <span class="n">-e</span> <span class="n">DISCORD_TOKEN</span><span class="p">=</span><span class="s2">&#34;$env:DISCORD_TOKEN&#34;</span> <span class="p">-</span><span class="n">-restart</span> <span class="n">unless-stopped</span> <span class="n">mysupercoolregistry</span><span class="p">.</span><span class="n">azurecr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">discord-bot</span><span class="err">:</span><span class="n">latest</span>
</code></pre></td></tr></table>
</div>
</div><p>And that&rsquo;s it, we&rsquo;re all set up and running. The bot will always run unless I manually turn it off in Docker. Thanks for reading all the way through. If I feel like it, I&rsquo;ll put up a blog post about how I set up CI/CD to deploy new updates to ACR using Azure DevOps Pipelines and GitHub.</p>
]]></content>
            
            
            
            
            
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/categories/development/" term="development" label="development" />
                            
                        
                    
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/js/" term="js" label="js" />
                            
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/tags/docker/" term="docker" label="docker" />
                            
                        
                    
                
            
        </entry>
    
        <entry>
            <title type="text">Hello World</title>
            <link rel="alternate" type="text/html" href="https://blog.iamdavidfrancis.com/posts/hello-world/" />
            <id>https://blog.iamdavidfrancis.com/posts/hello-world/</id>
            <updated>2020-04-11T17:02:19-07:00</updated>
            <published>2020-04-11T16:48:41-07:00</published>
            <author>
                    <name>David Francis</name>
                    <uri>https://iamdavidfrancis.com/</uri>
                    <email>david@iamdavidfrancis.com</email>
                    </author>
            <summary type="html"><![CDATA[Hello there! Welcome to my blog. I can&rsquo;t believe I&rsquo;m doing this, but here we are. If you think this is dumb and I didn&rsquo;t need a blog, same. Someone asked my to write up a blog post about a personal project I did, so here we are.]]></summary>
            
                <content type="html"><![CDATA[<p>Hello there! Welcome to my blog. I can&rsquo;t believe I&rsquo;m doing this, but here we are. If you think this is dumb and I didn&rsquo;t need a blog, same. Someone asked my to write up a blog post about a personal project I did, so here we are. Honestly this was a lot of work and I&rsquo;d much rather be sleeping, but sleeping never got me anywhere so screw that. Don&rsquo;t expect a serious tone from me as I&rsquo;m like one step above &ldquo;I&rsquo;m here so I don&rsquo;t get fined.&rdquo; I know you&rsquo;re going to ask question like &ldquo;Isn&rsquo;t this a personal blog?&rdquo; and &ldquo;It&rsquo;s not like you&rsquo;re being forced to write it right?&rdquo; and while those are both correct, it really undercuts the constant complaining motif I was going for.</p>
<p>Don&rsquo;t expect a lot of updates, I&rsquo;ve never been able to do that consistently. I figure if I set your expectations low enough now, I will have less disappointment later. So, to recap:</p>
<ol>
<li>Don&rsquo;t expect a lot of posts</li>
<li>Don&rsquo;t expect a serious tone all the time.</li>
<li>Don&rsquo;t be a dick.</li>
</ol>
<p>Thanks for reading, I guess. Honestly I&rsquo;m surprised you made it this far. I guess I&rsquo;m not the only one with nothing better to do.</p>
]]></content>
            
            
            
            
            
                
                    
                        
                            
                            
                            
                                <category scheme="https://blog.iamdavidfrancis.com/categories/meta/" term="meta" label="meta" />
                            
                        
                    
                
                    
                
            
        </entry>
    
</feed>
